services:
  # ==========================================
  # CHATWOOT (Web & Worker)
  # ==========================================
  chatwoot-web:
    image: chatwoot/chatwoot:v3.12.0
    container_name: chatwoot-web
    restart: always
    env_file: ../../.env
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      FRONTEND_URL: https://chat.${DOMAIN}
      POSTGRES_DATABASE: chatwoot
      POSTGRES_USERNAME: chatwoot_user
      POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD}
      POSTGRES_HOST: db_core
      REDIS_URL: redis://:${REDIS_PASSWORD}@cache_core:6379/0
      # S3 Configuration (Public Alignment)
      ACTIVE_STORAGE_SERVICE: s3_compatible
      STORAGE_BUCKET_NAME: chatwoot-storage
      STORAGE_ACCESS_KEY_ID: minioadmin
      STORAGE_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      STORAGE_ENDPOINT: https://s3.${DOMAIN}
      STORAGE_FORCE_PATH_STYLE: "true"
      STORAGE_REGION: us-east-1
      RAILS_SERVE_STATIC_FILES: "true"
      RAILS_LOG_TO_STDOUT: "true"
      RACK_TIMEOUT_SERVICE_TIMEOUT: 0
    command: /bin/sh -c "rm -f /app/tmp/pids/server.pid && bundle exec rails s -p 3000 -b 0.0.0.0"
    volumes:
      - chatwoot_data:/app/storage
    networks:
      - secure-net
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
    ports:
      - "127.0.0.1:3000:3000"

  chatwoot-worker:
    image: chatwoot/chatwoot:v3.12.0
    container_name: chatwoot-worker
    restart: always
    env_file: ../../.env
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      POSTGRES_DATABASE: chatwoot
      POSTGRES_USERNAME: chatwoot_user
      POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD}
      POSTGRES_HOST: db_core
      REDIS_URL: redis://:${REDIS_PASSWORD}@cache_core:6379/0
      # Worker also needs S3 config for processing
      SIDEKIQ_CONCURRENCY: 50
      ACTIVE_STORAGE_SERVICE: s3_compatible
      STORAGE_BUCKET_NAME: chatwoot-storage
      STORAGE_ACCESS_KEY_ID: minioadmin
      STORAGE_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      STORAGE_ENDPOINT: https://s3.${DOMAIN}
      STORAGE_FORCE_PATH_STYLE: "true"
      STORAGE_REGION: us-east-1
    command: bundle exec sidekiq -C config/sidekiq.yml
    volumes:
      - chatwoot_data:/app/storage
    networks:
      - secure-net
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G

  # ==========================================
  # EVOLUTION API
  # ==========================================
  app_evolution:
    image: evolution-api:sentinel
    container_name: app_evolution
    restart: always
    env_file: ../../.env
    environment:
      DOMAIN: ${DOMAIN}
      SERVER_URL: https://api.${DOMAIN}
      AUTHENTICATION_API_KEY: ${EVOLUTION_API_KEY}
      AUTHENTICATION_TYPE: apikey
      AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES: "true"
      DATABASE_CONNECTION_POOL_MAX: 30
      DATABASE_ENABLED: "true"
      DATABASE_PROVIDER: postgresql
      DATABASE_CONNECTION_URI: postgresql://evolution_user:${EVOLUTION_DB_PASSWORD}@db_core:5432/evolution?schema=public
      CHATWOOT_IMPORT_DATABASE_CONNECTION_URI: ${CHATWOOT_IMPORT_DATABASE_CONNECTION_URI}
      CACHE_REDIS_ENABLED: "true"
      CACHE_REDIS_URI: redis://default:${REDIS_PASSWORD}@cache_core:6379/0
      # S3 Configuration (Public Alignment)
      S3_ENABLED: "true"
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      S3_BUCKET: evolution-media
      S3_PORT: 443
      S3_ENDPOINT: s3.${DOMAIN}
      S3_REGION: us-east-1
      S3_FORCE_PATH_STYLE: "true"
      S3_USE_SSL: "true"
      CORS_ORIGIN: "*"
      VITE_EVOLUTION_API_URL: https://api.${DOMAIN}
      VITE_EVOLUTION_API_KEY: ${EVOLUTION_API_KEY}
      CHATWOOT_ENABLED: "true"
      CHATWOOT_MESSAGE_REOPEN: "true"
      CHATWOOT_MESSAGE_WA_INDICATOR: "true"
      CHATWOOT_IMPORT_CONTACTS: "true"
      CHATWOOT_IMPORT_MESSAGES: "true"
      # IO Optimization
      UV_THREADPOOL_SIZE: "128"
    volumes:
      - ../../persistence/evolution/instances:/evolution/instances
      - ../../persistence/evolution/store:/evolution/store
    networks:
      - secure-net
    ports:
      - "127.0.0.1:8080:8080"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # N8N
  # ==========================================
  app_n8n_editor:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: app_n8n_editor
    restart: always
    env_file: ../../.env
    environment:
      N8N_HOST: n8n.${DOMAIN}
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      WEBHOOK_URL: https://n8n.${DOMAIN}/
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: db_core
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n_user
      DB_POSTGRESDB_PASSWORD: ${N8N_DB_PASSWORD}
    volumes:
      - ../../persistence/n8n:/home/node/.n8n
    networks:
      - secure-net
    ports:
      - "127.0.0.1:5678:5678"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

networks:
  secure-net:
    external: true

volumes:
  chatwoot_data:
